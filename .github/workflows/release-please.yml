name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
    steps:
      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          config-file: .github/release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Add deployment instructions to release
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.release.outputs.version }}';
            const major = '${{ steps.release.outputs.major }}';
            const minor = '${{ steps.release.outputs.minor }}';
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            // Get the release
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag: 'v' + version
            });
            
            // Comprehensive deployment instructions
            const deploymentInstructions = `
            
            ---
            
            ## üê≥ Docker Deployment
            
            Docker images for this release are automatically built and published to GitHub Container Registry.
            
            ### Quick Start
            
            \`\`\`bash
            # Pull the image
            docker pull ghcr.io/${owner}/${repo}:${version}
            
            # Run with persistent data
            docker run -d \\
              --name video-ware \\
              -p 80:80 \\
              -v pb_data:/app/pb/pb_data \\
              -v worker_data:/app/data \\
              -e POCKETBASE_ADMIN_EMAIL=admin@example.com \\
              -e POCKETBASE_ADMIN_PASSWORD=your-secure-password \\
              ghcr.io/${owner}/${repo}:${version}
            \`\`\`
            
            ### Available Image Tags
            
            | Tag | Description |
            |-----|-------------|
            | \`ghcr.io/${owner}/${repo}:${version}\` | This specific version |
            | \`ghcr.io/${owner}/${repo}:${major}.${minor}\` | Latest patch for v${major}.${minor} |
            | \`ghcr.io/${owner}/${repo}:${major}\` | Latest minor for v${major} |
            | \`ghcr.io/${owner}/${repo}:latest\` | Latest stable release |
            
            ### Supported Architectures
            
            - \`linux/amd64\` - Standard x86_64 servers, Intel/AMD CPUs
            - \`linux/arm64\` - Apple Silicon Macs, AWS Graviton, ARM servers
            
            ### Environment Variables
            
            <details>
            <summary>Click to expand environment variable reference</summary>
            
            #### PocketBase Configuration
            | Variable | Default | Description |
            |----------|---------|-------------|
            | \`POCKETBASE_URL\` | \`http://localhost:8090\` | PocketBase server URL |
            | \`POCKETBASE_ADMIN_EMAIL\` | \`admin@example.com\` | Admin email |
            | \`POCKETBASE_ADMIN_PASSWORD\` | \`your-secure-password\` | Admin password |
            | \`PB_DATA_DIR\` | \`/app/pb/pb_data\` | Data storage directory |
            
            #### Worker Configuration
            | Variable | Default | Description |
            |----------|---------|-------------|
            | \`WORKER_MAX_RETRIES\` | \`3\` | Max retry attempts |
            | \`WORKER_PROVIDER\` | \`ffmpeg\` | Media provider (\`ffmpeg\` or \`google\`) |
            
            #### Monitoring
            | Variable | Default | Description |
            |----------|---------|-------------|
            | \`LOG_LEVEL\` | \`info\` | Log level (\`debug\`, \`info\`, \`warn\`, \`error\`) |
            | \`METRICS_ENABLED\` | \`false\` | Enable Prometheus metrics |
            
            </details>
            
            ### Docker Compose Example
            
            <details>
            <summary>Click to expand Docker Compose configuration</summary>
            
            \`\`\`yaml
            version: '3.8'
            services:
              video-ware:
                image: ghcr.io/${owner}/${repo}:${version}
                container_name: video-ware
                restart: unless-stopped
                ports:
                  - "80:80"
                volumes:
                  - pb_data:/app/pb/pb_data
                  - worker_data:/app/data
                environment:
                  - POCKETBASE_ADMIN_EMAIL=admin@example.com
                  - POCKETBASE_ADMIN_PASSWORD=your-secure-password
                  - LOG_LEVEL=info
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            
            volumes:
              pb_data:
              worker_data:
            \`\`\`
            
            </details>
            
            ### Kubernetes Deployment
            
            <details>
            <summary>Click to expand Kubernetes manifests</summary>
            
            \`\`\`yaml
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: video-ware
              labels:
                app: video-ware
            spec:
              replicas: 1
              selector:
                matchLabels:
                  app: video-ware
              template:
                metadata:
                  labels:
                    app: video-ware
                spec:
                  containers:
                  - name: video-ware
                    image: ghcr.io/${owner}/${repo}:${version}
                    ports:
                    - containerPort: 80
                    env:
                    - name: POCKETBASE_ADMIN_EMAIL
                      valueFrom:
                        secretKeyRef:
                          name: video-ware-secrets
                          key: admin-email
                    - name: POCKETBASE_ADMIN_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: video-ware-secrets
                          key: admin-password
                    volumeMounts:
                    - name: pb-data
                      mountPath: /app/pb/pb_data
                    - name: worker-data
                      mountPath: /app/data
                    livenessProbe:
                      httpGet:
                        path: /health
                        port: 80
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /health
                        port: 80
                      initialDelaySeconds: 5
                      periodSeconds: 5
                  volumes:
                  - name: pb-data
                    persistentVolumeClaim:
                      claimName: video-ware-data
                  - name: worker-data
                    persistentVolumeClaim:
                      claimName: video-ware-worker-data
            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: video-ware
            spec:
              selector:
                app: video-ware
              ports:
              - port: 80
                targetPort: 80
              type: ClusterIP
            \`\`\`
            
            </details>
            
            ### Documentation
            
            - üìñ [Docker README](docker/README.md) - Full deployment documentation
            - üîß [Environment Variables](docker/README.md#environment-variables) - Complete configuration reference
            - üîí [Security Scanning](docker/README.md#security-scanning) - Vulnerability scanning details
            `;
            
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body: release.body + deploymentInstructions
            });

  # Trigger Docker build after release is created
  trigger-docker-build:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Docker Build Workflow
        uses: actions/github-script@v7
        with:
          script: |
            // The docker-build.yml workflow is automatically triggered by the release event
            // This step just logs the trigger for visibility
            console.log('Release created, Docker build will be triggered automatically');
            console.log('Version:', '${{ needs.release-please.outputs.version }}');
            console.log('Tag:', '${{ needs.release-please.outputs.tag_name }}');

      - name: Add build status comment
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.release-please.outputs.version }}';
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            // Get the release
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag: 'v' + version
            });
            
            // Add a comment about the Docker build status
            const buildStatusNote = `
            
            ---
            
            > üîÑ **Docker Build Status**: A multi-architecture Docker image build has been triggered for this release.
            > Check the [Actions tab](https://github.com/${owner}/${repo}/actions/workflows/docker-build.yml) for build progress.
            `;
            
            // Only add if not already present
            if (!release.body.includes('Docker Build Status')) {
              await github.rest.repos.updateRelease({
                owner,
                repo,
                release_id: release.id,
                body: release.body + buildStatusNote
              });
            }
